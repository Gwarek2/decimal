#include <stdio.h>
#include <string.h>
#include "dev_decimal.h"

// Функция выводит значение типа decimal
void out_decimal(s21_decimal dst) {
    char res[30];
    ini_arr(res);
    
    int d = 0;
    for (int i = 0; i < 3; i ++) {
        d = 32 * i;
        int num = dst.bits[i];
        if (num < 0)
            num = -num;
        while (num > 0) {
            if ((num & 1) == 1)
                add_degree(res, d);
            num >>= 1;
            d++;
        }
    }
    
    int num = dst.bits[3];
    if (num < 0) {
        printf("-");
        num -= SIGN_MASK;
    }
    num >>= 16;
    
//    printf("exp = %d\n", num);
    // печать точки или степени 10 (-n)
//    printf("zero_shift(res) = %d\n", zero_shift(res));
    int zes = zero_shift(res);
    if (zes == 29)
        zes = 28;
    for (int i = zes; i < 29; i ++) {
        if (i == (29 - num))
            printf(".");
        printf("%c", res[i]);
    }
    printf("\n");

}

// Функция инициализирует цифрой 0 массив str
void ini_arr(char *str) {
    for (int i = 0; i < 29; i++)
        str[i] = 48;
    str[29] = '\0';
}

// Функция возвращает индекс первого ненулевого значения str
int zero_shift(const char *str) {
    int i = 0;
    for (; i < 29; i++)
        if (str[i] != 48)
            break;
    return i;
}

// Функция прибавляет к значению в str значение 2 в степени d
int add_degree(char *str, int d) {
    char degree[][30] = {
        "00000000000000000000000000001",
        "00000000000000000000000000002",
        "00000000000000000000000000004",
        "00000000000000000000000000008",
        "00000000000000000000000000016",
        "00000000000000000000000000032",
        "00000000000000000000000000064",
        "00000000000000000000000000128",
        "00000000000000000000000000256",
        "00000000000000000000000000512",
        "00000000000000000000000001024",
        "00000000000000000000000002048",
        "00000000000000000000000004096",
        "00000000000000000000000008192",
        "00000000000000000000000016384",
        "00000000000000000000000032768",
        "00000000000000000000000065536",
        "00000000000000000000000131072",
        "00000000000000000000000262144",
        "00000000000000000000000524288",
        "00000000000000000000001048576",
        "00000000000000000000002097152",
        "00000000000000000000004194304",
        "00000000000000000000008388608",
        "00000000000000000000016777216",
        "00000000000000000000033554432",
        "00000000000000000000067108864",
        "00000000000000000000134217728",
        "00000000000000000000268435456",
        "00000000000000000000536870912",
        "00000000000000000001073741824",
        "00000000000000000002147483648",
        "00000000000000000004294967296",
        "00000000000000000008589934592",
        "00000000000000000017179869184",
        "00000000000000000034359738368",
        "00000000000000000068719476736",
        "00000000000000000137438953472",
        "00000000000000000274877906944",
        "00000000000000000549755813888",
        "00000000000000001099511627776",
        "00000000000000002199023255552",
        "00000000000000004398046511104",
        "00000000000000008796093022208",
        "00000000000000017592186044416",
        "00000000000000035184372088832",
        "00000000000000070368744177664",
        "00000000000000140737488355328",
        "00000000000000281474976710656",
        "00000000000000562949953421312",
        "00000000000001125899906842624",
        "00000000000002251799813685248",
        "00000000000004503599627370496",
        "00000000000009007199254740992",
        "00000000000018014398509481984",
        "00000000000036028797018963968",
        "00000000000072057594037927936",
        "00000000000144115188075855872",
        "00000000000288230376151711744",
        "00000000000576460752303423488",
        "00000000001152921504606846976",
        "00000000002305843009213693952",
        "00000000004611686018427387904",
        "00000000009223372036854775808",
        "00000000018446744073709551616",
        "00000000036893488147419103232",
        "00000000073786976294838206464",
        "00000000147573952589676412928",
        "00000000295147905179352825856",
        "00000000590295810358705651712",
        "00000001180591620717411303424",
        "00000002361183241434822606848",
        "00000004722366482869645213696",
        "00000009444732965739290427392",
        "00000018889465931478580854784",
        "00000037778931862957161709568",
        "00000075557863725914323419136",
        "00000151115727451828646838272",
        "00000302231454903657293676544",
        "00000604462909807314587353088",
        "00001208925819614629174706176",
        "00002417851639229258349412352",
        "00004835703278458516698824704",
        "00009671406556917033397649408",
        "00019342813113834066795298816",
        "00038685626227668133590597632",
        "00077371252455336267181195264",
        "00154742504910672534362390528",
        "00309485009821345068724781056",
        "00618970019642690137449562112",
        "01237940039285380274899124224",
        "02475880078570760549798248448",
        "04951760157141521099596496896",
        "09903520314283042199192993792",
        "19807040628566084398385987584",
        "39614081257132168796771975168",
        "79228162514264337593543950336"
    };
    char tmp[30];
    ini_arr(tmp);
    int shift = 0, i = 28;
    for (; i > 0; i--) {
        int val = str[i] + degree[d][i] + shift - 96, ost = 0;
        if (val >= 10) {
            val -= 10;
            ost = 1;
        }
        tmp[i] = val + 48;
        shift = ost;
    }
    if (shift != 1)
        strcpy(str, tmp);
    return shift;
}


